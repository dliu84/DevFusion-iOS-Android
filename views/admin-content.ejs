<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Content Management</title>
  <link rel="stylesheet" href="/css/main.css" />
</head>

<body tabindex="-1" class="bg-gray-100 text-gray-900 font-sans">

  <!-- Navbar -->
  <%- include('partials/navbar', {page: '/admin'}) %>

  <div class="container mx-auto my-8 p-6 bg-white shadow-lg rounded-lg">
    <h1 class="text-4xl font-extrabold text-gray-800 mb-8 text-center">Admin Portal</h1>

    <% 
  const searchQuery = search || ''; // Default search to empty string
  const currentSortBy = sortBy || 'date'; // Default sort to 'date'
  const currentFilterType = filterType || ''; // Default filter to 'All'
  %>

  <!-- Search, Sort, and Filter Controls -->
  <div class="mb-10 flex justify-between items-center">
    
  <!-- Search Bar -->
  <form method="GET" action="/admin" class="flex space-x-4">
    <input 
      type="text" 
      name="search" 
      placeholder="Search by topic or keyword" 
      value="<%= searchQuery %>"
      class="border border-gray-300 p-2 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-400 focus:border-transparent"
    >
    <button 
      type="submit" 
      class="bg-blue-500 text-white px-4 py-2 rounded shadow hover:bg-blue-600 transition duration-300">
      Search
    </button>
  </form>

  <!-- Sort and Filter Dropdowns -->
  <form method="GET" action="/admin" class="flex space-x-4 items-center">
    
    <!-- Sort Dropdown -->
    <div>
      <label for="sortBy" class="mr-2 ml-4 font-semibold text-gray-700">Sort by:</label>
      <select 
        name="sortBy" 
        id="sortBy" 
        class="border border-gray-300 p-2 rounded-lg shadow-sm"
        onchange="this.form.submit()"
      >
        <option value="date" <%= currentSortBy === 'date' ? 'selected' : '' %>>Date</option>
        <option value="topic" <%= currentSortBy === 'topic' ? 'selected' : '' %>>Topic</option>
      </select>
    </div>

    <!-- Filter Dropdown -->
    <div>
          <label for="filterType" class="mr-2 font-semibold text-gray-700">Filter by type:</label>
          <select 
            name="filterType" 
            id="filterType" 
            class="border border-gray-300 p-2 rounded-lg shadow-sm"
            onchange="this.form.submit()"
          >
            <option value="" <%= currentFilterType === '' ? 'selected' : '' %>>All</option>
            <option value="article" <%= currentFilterType === 'article' ? 'selected' : '' %>>Article</option>
            <option value="video" <%= currentFilterType === 'video' ? 'selected' : '' %>>Video</option>
          </select>
        </div>
        
      </form>
    </div>

    <!-- Content List -->
    <div class="mb-10">
      <h2 class="text-2xl font-semibold text-gray-700 mb-4">Content</h2>
      <ul class="list-disc pl-6 space-y-3">
        <% contentList.forEach((content) => { %>
          <li class="text-lg text-gray-800">
            <span class="font-semibold"> <%= content.topic %> </span>
            <button onclick="editContent('<%= content._id %>')" class="ml-4 bg-yellow-500 text-white px-4 py-1 rounded shadow hover:bg-yellow-600 transition duration-300">
              Edit
            </button>
            <% if(content.order == contentList.length) { %>
            <button onclick="deleteContent('<%= content._id %>')" class="ml-4 bg-blue-500 text-white px-4 py-1 rounded shadow hover:bg-yellow-600 transition duration-300">
              Delete
            </button>
            <% } %>
          </li>
        <% }) %>
      </ul>
    </div>

    <!-- Add New Content Button -->
    <button id="add-new-content" class="bg-green-500 text-white px-6 py-2 rounded shadow-lg hover:bg-green-600 transition duration-300">
      + Add New Content
    </button>

    <!-- Add/Edit Content Form -->
    <div id="content-form" class="hidden mt-8 bg-gray-50 p-6 rounded-lg shadow-lg relative">
      <button id="close-form" class="absolute top-2 right-2 text-gray-600 hover:text-gray-900" aria-label="Close">
        &times;
      </button>
      <h2 class="text-2xl font-semibold text-gray-700 mb-6" id="form-topic">Add New Content</h2>
      <form method="POST" action="/admin/content" id="contentForm" class="space-y-4">
        <input type="hidden" name="contentId" id="contentId">

        <!-- Topic Input -->
        <div>
          <label for="topic" class="block text-lg font-medium text-gray-700 mb-1">Topic</label>
          <input type="text" id="topic" name="topic" class="border border-gray-300 p-3 w-full rounded-lg shadow-sm focus:ring-2 focus:ring-blue-400 focus:border-transparent" required>
        </div>

        <!-- Body Input -->
        <div>
          <label for="body" class="block text-lg font-medium text-gray-700 mb-1">Body (HTML)</label>
          <textarea id="body" name="body" rows="6" class="border border-gray-300 p-3 w-full rounded-lg shadow-sm focus:ring-2 focus:ring-blue-400 focus:border-transparent" required></textarea>
        </div>

        <!-- Submit Button -->
        <button type="submit" class="bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg hover:bg-blue-600 transition duration-300">
          Save Content
        </button>
      </form>
    </div>
  </div>

  <!-- Confirmation Prompt -->
<div id="delete-confirmation" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center">
  <div class="bg-white p-6 rounded-lg shadow-lg">
    <h2 class="text-xl font-bold text-gray-800 mb-4">Are you sure you want to delete this content?</h2>
    <div class="flex justify-end">
      <button id="cancel-delete" class="bg-yellow-500 text-white px-4 py-1 rounded shadow hover:bg-yellow-600 transition duration-300">Cancel</button>
      <button id="confirm-delete" class="ml-4 bg-yellow-500 text-white px-4 py-1 rounded shadow hover:bg-yellow-600 transition duration-300">Delete</button>
    </div>
  </div>
</div>

  <script>
    // Toggle form for adding or editing content
    document.getElementById('add-new-content').addEventListener('click', function() {
      document.getElementById('content-form').classList.toggle('hidden');
      document.getElementById('form-topic').innerText = 'Add New Content';
      document.getElementById('contentForm').action = '/admin/content';
      document.getElementById('contentId').value = '';
      document.getElementById('topic').value = '';
      document.getElementById('body').value = '';
    });

    // Pre-fill form for editing content
    function editContent(id) {
      fetch(`/admin/content/${id}/edit`)
        .then(response => response.json())
        .then(data => {
          document.getElementById('content-form').classList.remove('hidden');
          document.getElementById('form-topic').innerText = 'Edit Content';
          document.getElementById('contentForm').action = `/admin/content/${id}/update`;
          document.getElementById('contentId').value = data._id;
          document.getElementById('topic').value = data.topic;
          document.getElementById('body').value = data.body;
        });
    }

    // Delete confirmation logic
    let deleteContentId = '';

    function deleteContent(id) {
      deleteContentId = id;
      document.getElementById('delete-confirmation').classList.remove('hidden');
    }

    document.getElementById('cancel-delete').addEventListener('click', function() {
      document.getElementById('delete-confirmation').classList.add('hidden');
    });

    document.getElementById('confirm-delete').addEventListener('click', function() {
      fetch(`/admin/content/delete`, { method: 'DELETE' })
        .then(response => response.json())
        .then(data => {
          window.location.reload();
        });
    });

    // Close the form
    document.getElementById('close-form').addEventListener('click', function() {
      document.getElementById('content-form').classList.add('hidden');
    });
  </script>
</body>
</html>
